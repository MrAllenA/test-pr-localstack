name: PR Preview - FastAPI + Localstack

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  pr-preview:
    if: github.event.action != 'closed'  # Only run preview steps for opened/sync/reopened
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Start Docker Compose (Localstack + Postgres)
      - name: Start Docker Compose
        run: |
          docker compose up -d
          sleep 20  # wait for Localstack + Postgres to be ready

      # 5. Start FastAPI app with logging
      - name: Start FastAPI
        run: |
          echo "ðŸš€ Starting FastAPI app..."
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 > fastapi.log 2>&1 &
          sleep 10
          tail -n 20 fastapi.log

      # 6. Start ngrok tunnel
      - name: Start ngrok
        id: ngrok
        uses: apogiatzis/ngrok-tunneling-action@v1
        with:
          ngrok_authtoken: ${{ secrets.NGROK_AUTH_TOKEN }}
          port: 8000
          proto: http
          timeout: 1h
          save_url_to_filename: tunnelURL.md
          region: us

      # 7. Comment PR with ngrok URL
      - name: Comment PR with preview URL
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ðŸš€ PR Preview is live: $(cat tunnelURL.md)

  pr-teardown:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Tear down Docker Compose
        run: |
          echo "ðŸ›‘ PR closed. Shutting down Docker Compose..."
          docker compose down
