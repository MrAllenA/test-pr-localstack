name: PR Preview - FastAPI + Localstack

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-preview:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Start Docker Compose (Localstack + Postgres)
      - name: Start Docker Compose
        run: |
          docker-compose up -d
          # Wait for Localstack to be ready
          sleep 15

      # 5. Start FastAPI app
      - name: Start FastAPI
        run: |
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      # 6. Start ngrok tunnel
      - name: Start ngrok
        id: ngrok
        uses: ngrok/ngrok-action@v1
        with:
          token: ${{ secrets.NGROK_AUTH_TOKEN }}
          port: 8000
          proto: http

      # 7. Comment PR with preview URL
      - name: Comment PR with preview URL
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ðŸš€ PR Preview is live:
            ${{ steps.ngrok.outputs.url }}
